name: 'Run tests'

runs:
  using: "composite"
  steps:
    - name: Run Python tests - CPU
      shell: bash
      env:
        DEVICE: cpu
      run: |
        echo "::group::Run Python tests - CPU"
        python -m tests discover python/tests -v
        echo "::endgroup::"

    - name: Run Python tests - GPU
      if: ${{ !(runner.os == 'Linux' && startsWith(runner.name, 'GitHub Actions') }}
      shell: bash
      env:
        DEVICE: gpu
        METAL_DEBUG_ERROR_MODE: 0
        METAL_DEVICE_WRAPPER_TYPE: 1
      run: |
        echo "::group::Run Python tests - GPU"
        python -m tests discover python/tests -v
        echo "::endgroup::"

    - name: Run distributed tests
      shell: bash
      run: |
        echo "::group::Run distributed tests"
        mpirun --bind-to none --allow-run-as-root -host localhost:8 -np 8 python python/tests/mpi_test_distributed.py
        mlx.launch --verbose -n 8 python/tests/ring_test_distributed.py -v 2> >(tee -a stderr.log >&2)
        if grep -Fq '[WARN]' stderr.log ; then
          grep -F '[WARN]' stderr.log
          echo "Distributed ring test failed";
          exit 1;
        fi
        echo "::endgroup::"

    - name: Run CPP tests - CPU
      shell: bash
      env:
        DEVICE: cpu
      run: |
        echo "::group::Run CPP tests - CPU"
        ./build/tests/tests
        echo "::endgroup::"

    - name: Run CPP tests - GPU
      if: ${{ !(runner.os == 'Linux' && (startsWith(runner.name, 'GitHub Actions') || startsWith(runner.name, 'gpu'))) }}
      shell: bash
      env:
        DEVICE: gpu
        METAL_DEBUG_ERROR_MODE: 0
        METAL_DEVICE_WRAPPER_TYPE: 1
      run: |
        echo ${{ runner.name }}
        echo "::group::Run CPP tests - GPU"
        ./build/tests/tests
        echo "::endgroup::"

    - name: Run CPP tests - CUDA
      if: ${{ startsWith(runner.name, 'gpu') }}
      shell: bash
      env:
        DEVICE: gpu
      run: |
        echo "::group::Run CPP tests - CUDA"
        ./build/tests/tests -sfe="*fft_tests.cpp,*linalg_tests.cpp"
        echo "::endgroup::"
