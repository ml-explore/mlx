name: 'Run tests'

runs:
  using: "composite"
  steps:
    - name: Run Python tests
      run: |
        echo "::group::Run Python tests"
        python -m tests discover python/tests -v
        echo "::endgroup::"

    - name: Run distributed tests
      if: runner.os == 'Linux'
      run: |
        echo "::group::Run distributed tests"
        mpirun --bind-to none --allow-run-as-root -host localhost:8 -np 8 python python/tests/mpi_test_distributed.py
        mlx.launch --verbose -n 8 python/tests/ring_test_distributed.py -v 2> >(tee -a stderr.log >&2)
        if grep -Fq '[WARN]' stderr.log ; then
          grep -F '[WARN]' stderr.log
          echo "Distributed ring test failed";
          exit 1;
        fi
        echo "::endgroup::"

    - name: Run CPP tests
      run: |
        echo "::group::Run CPP tests"
        ./build/tests/tests
        echo "::endgroup::"
